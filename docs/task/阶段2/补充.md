å¤ªå¥½äº†ï¼Œè¿™ä»½åé¦ˆéå¸¸å…·ä½“ ğŸ‘
æˆ‘ä¸‹é¢å°±æŒ‰ä½ åˆ—çš„å‡ ä¸ªç‚¹ï¼Œä¸€æ¡æ¡ç»™å‡º**æ˜ç¡®å†³ç­– + å¼€å‘è§„èŒƒ**ï¼Œä½ ä»¬å¯ä»¥ç›´æ¥å†™è¿› `é˜¶æ®µ2/arch.md` æˆ–è¡¥å……åˆ°ç°æœ‰æ–‡æ¡£é‡Œã€‚

---

## 1. Embedding Service ç»†èŠ‚ï¼ˆæ¨¡å‹æ”¾å“ªã€æ€ä¹ˆéƒ¨ç½²ã€GPU è¦æ±‚ï¼‰

æˆ‘ä»¬å…ˆ**å®šä¸€ä¸ªé»˜è®¤æ–¹æ¡ˆ**ï¼Œé¿å…å¤§å®¶å†çŠ¹è±«ï¼š

> **é˜¶æ®µäºŒ MVPï¼šEmbedding Service å…ˆå¤ç”¨ç°æœ‰ FastAPI åç«¯è¿›ç¨‹ï¼Œä¸å•ç‹¬æ‹†æœåŠ¡ã€‚**

ç­‰ä»¥å QPS ä¸Šæ¥æˆ–è¦å¤šæœºéƒ¨ç½²ï¼Œå†æ‹†ã€‚

### 1.1 æ¨¡å‹è·å– & å­˜æ”¾è·¯å¾„

* æ¨¡å‹ï¼š**Qwen3-Embedding-0.6B**ï¼ˆHF / ModelScope åŒæºï¼‰
* ç›®å½•è§„èŒƒï¼ˆå»ºè®®å†™è¿› configï¼‰ï¼š

```text
project_root/
  models/
    qwen3-embedding-0.6b/
      config.json
      model.safetensors
      tokenizer.json
      ...
```

* é…ç½®é¡¹ï¼ˆ`.env` æˆ– config æ–‡ä»¶ï¼‰ï¼š

```text
EMBEDDING_MODEL_NAME=qwen3-embedding-0.6b
EMBEDDING_MODEL_PATH=./models/qwen3-embedding-0.6b
EMBEDDING_DEVICE=cuda  # æˆ– auto/cpu
```

### 1.2 GPU / å†…å­˜éœ€æ±‚ï¼ˆåŸºäºä½ æœºå™¨ï¼‰

ä½ æœ‰ RTX 4070 8GBï¼š

* 0.6B çš„ embedding æ¨¡å‹ **å®Œå…¨å¤Ÿç”¨**ï¼š

  * æ˜¾å­˜å ç”¨ï¼šå¤§çº¦ 1â€“2 GBï¼ˆå–å†³äºç²¾åº¦ float16/bf16ï¼‰
  * CPU å†…å­˜ä¸€èˆ¬ä¸ä¼šæˆä¸ºç“¶é¢ˆ
* æ¨èï¼š

  * `device="cuda"`
  * `dtype=float16`

MVP æ–¹æ¡ˆï¼š

* æ¨¡å‹åŠ è½½æ—¶ï¼š

  * ä¼˜å…ˆå°è¯• GPU
  * æ•è·å¤±è´¥ â†’ fallback CPU å¹¶æ‰“ warning æ—¥å¿—

### 1.3 tokenizer æ€ä¹ˆåŠ è½½ï¼Ÿ

* å’Œæ¨¡å‹ä¸€èµ·æ”¾åœ¨ `EMBEDDING_MODEL_PATH`
* ç”¨å®˜æ–¹/transformers çš„ `AutoTokenizer.from_pretrained(EMBEDDING_MODEL_PATH)`
* åœ¨ `services/embedding/loader.py` é‡Œï¼Œå°è£…ï¼š

```python
def load_embedding_model():
    # åŠ è½½ tokenizer + model
    # è¿”å› (tokenizer, model)
```

ç”± `embedder.py` ç»Ÿä¸€ä½¿ç”¨ã€‚

### 1.4 è¿›ç¨‹æ‹“æ‰‘ï¼ˆå…ˆç®€å•ã€åæ‰©å±•ï¼‰

**å½“å‰å†³å®šï¼š**

* å…ˆ**ä¸å•ç‹¬æ‹† Embedding å¾®æœåŠ¡**ï¼Œè€Œæ˜¯ï¼š

  * åœ¨ç°æœ‰ FastAPI app å†…æ–°å¢ `/embed` è·¯ç”±
  * æ¨¡å‹åœ¨ app å¯åŠ¨æ—¶åŠ è½½ä¸ºä¸€ä¸ªå…¨å±€å•ä¾‹

**æœªæ¥å¯ä»¥æ¼”è¿›ä¸ºï¼š**

* `backend-embedding` ç‹¬ç«‹è¿›ç¨‹ï¼š

  * ç‹¬ç«‹ç«¯å£ï¼ˆä¾‹å¦‚ `:9001`ï¼‰
  * é˜¶æ®µä¸€/é˜¶æ®µäºŒåç«¯é€šè¿‡ HTTP æˆ–å†…éƒ¨ RPC è°ƒç”¨ `/embed`
  * å†…ç½‘ç¯å¢ƒä¸‹å¯ä»¥å…ˆä¸åšå¤æ‚é‰´æƒï¼ŒåªåŠ ä¸€ä¸ªå†…éƒ¨ token å¤´å³å¯

ç°åœ¨å…ˆ**ä¸å¢åŠ è¿ç»´å¤æ‚åº¦**ï¼Œå…å¾—ä¸€ä¸Šæ¥å°±å¤šè¿›ç¨‹ã€å¤šå®¹å™¨ã€‚

---

## 2. æ•°æ®æ¥æº & DB å­—æ®µï¼ˆPipeline ä»å“ªæ‹‰ Chunkï¼Ÿå­—æ®µè½åœ¨å“ªï¼Ÿï¼‰

> å†³ç­–ï¼š**é˜¶æ®µäºŒ Pipeline ç›´æ¥è®¿é—®é˜¶æ®µä¸€çš„æ•°æ®åº“ï¼ˆSQLModelï¼‰ï¼Œä¸èµ° HTTP APIã€‚**

ç†ç”±ï¼š

* éƒ½åœ¨åŒä¸€ä¸ªåç«¯é¡¹ç›®é‡Œï¼Œå…¬ç”¨åŒä¸€å¥— SQLModel
* ç›´æ¥æŸ¥ DB æ¯”ç»•ä¸€å±‚ HTTP ç®€å•ã€ç¨³å®š
* å‡å°‘ä¸€æ¬¡åºåˆ—åŒ–/ååºåˆ—åŒ–

### 2.1 ä»å“ªå¼ è¡¨è¯»æ•°æ®ï¼Ÿ

* ä½¿ç”¨ä½ é˜¶æ®µä¸€çš„ **Chunk è¡¨**ï¼ˆReady-to-Embed å¯¹åº”çš„é‚£å¼ ï¼‰
* Chunk è¡¨é‡Œåº”è¯¥å·²ç»æœ‰ï¼š

  * `id`
  * `course_id`
  * `lecture_id`
  * `section_id`
  * `text`
  * `language`
  * `source_type`
  * `metadata`

Pipeline åšçš„äº‹å°±æ˜¯ï¼š

```pseudo
SELECT * FROM chunk WHERE course_id = :course_id
```

æŒ‰ä¸€å®šåˆ†é¡µ/æ‰¹é‡æ‹‰å‡ºã€‚

### 2.2 embedding_status / progress / error è½åœ¨å“ªï¼Ÿ

> å†³ç­–ï¼šç»Ÿä¸€è½åœ¨ **Course è¡¨** ä¸Šï¼ˆè¯¾ç¨‹çº§çŠ¶æ€ï¼‰ã€‚

åœ¨ `Course` æ¨¡å‹ä¸Šæ–°å¢å­—æ®µï¼ˆéœ€ä¸€æ¬¡è¿ç§»ï¼‰ï¼š

* `embedding_status: str`

  * æšä¸¾ï¼š`"not_started" | "pending" | "running" | "done" | "failed"`
* `embedding_progress: float`

  * 0.0 ~ 1.0ï¼ˆMVP å¯ä»¥ç®€å•ç”¨å®Œæˆæ‰¹æ¬¡æ•° / æ€»æ‰¹æ¬¡æ•°ï¼‰
* `embedding_error: Optional[str]`

  * æœ€è¿‘ä¸€æ¬¡å¤±è´¥åŸå› æ–‡æœ¬

è¿ç§»æ–¹å¼ï¼ˆæŒ‰ä½ ä»¬ç°æœ‰ Alembic æˆ– SQLModel è¿ç§»æ–¹å¼è¡¥ä¸€æ¡è„šæœ¬å³å¯ï¼‰ã€‚

**å¥½å¤„ï¼š**

* åå°æŸ¥çœ‹è¯¾ç¨‹åˆ—è¡¨æ—¶èƒ½ä¸€çœ¼çœ‹åˆ° embedding çŠ¶æ€ï¼ˆä¸éœ€è¦å†æŸ¥åˆ«çš„è¡¨ï¼‰
* Search API èƒ½æ ¹æ® `embedding_status` å¿«é€Ÿåˆ¤æ–­æ˜¯å¦å¯æœç´¢

---

## 3. å‘é‡åº“éƒ¨ç½² & è¿ç»´ï¼ˆChroma æ–¹æ¡ˆç»†åŒ–ï¼‰

> å†³ç­–ï¼š**MVP é˜¶æ®µï¼ŒChroma ä½œä¸ºåµŒå…¥å¼æœ¬åœ°å‘é‡åº“ï¼Œè·‘åœ¨åŒä¸€åç«¯è¿›ç¨‹å†…ã€‚**

### 3.1 å­˜å‚¨ç›®å½• & æŒä¹…åŒ–ç­–ç•¥

* é…ç½®é¡¹ï¼š

```text
CHROMA_DB_DIR=./data/chroma
```

* Chroma å®¢æˆ·ç«¯ï¼š

```python
PersistentClient(path=CHROMA_DB_DIR)
```

* æŒä¹…åŒ–æ–¹æ¡ˆï¼š

  * Chroma ä¼šæŠŠå‘é‡å’Œç´¢å¼•è½ç›˜åœ¨ `CHROMA_DB_DIR`
  * å¤‡ä»½/æ¢å¤ï¼šç›´æ¥å¤‡ä»½æ•´ä¸ªç›®å½•å³å¯

### 3.2 æ•°æ®é‡é¢„ä¼°ï¼ˆå½“å‰é˜¶æ®µï¼‰

* æ¯é—¨è¯¾ç¨‹ï¼š

  * chunk æ•°é‡ï¼šå‡ åï½å‡ ç™¾
  * å‘é‡ç»´åº¦ï¼šå‡ ç™¾ï½å‡ åƒ
  * å•é—¨è¯¾ç¨‹é‡çº§ï¼š**å°åˆ°å®Œå…¨ä¸éœ€è¦é›†ç¾¤**

* å…¨ç³»ç»Ÿï¼š

  * åˆæœŸè¯¾ç¨‹æ•°é‡ä¸å¤š â†’ å•æœº + å•è¿›ç¨‹å®Œå…¨å¤Ÿç”¨

### 3.3 collection å‘½åè§„èŒƒ

* æ¯é—¨è¯¾ç¨‹ä¸€ä¸ª collectionï¼š

```text
collection_name = f"course_{course_id}"
```

ä¾‹å¦‚ï¼š

```text
course_1, course_2, course_abc123
```

* å¥½å¤„ï¼š

  * ç®€å•éš”ç¦»
  * åˆ é™¤/é‡å»ºå•é—¨è¯¾ç¨‹åªè¦åˆ è¿™ä¸ª collection

### 3.4 å¹¶å‘å†™å…¥ç­–ç•¥

* **åŒä¸€é—¨è¯¾ç¨‹ï¼šembedding pipeline ä¸²è¡Œæ‰§è¡Œ**

  * `POST /courses/{id}/embed` å†…éƒ¨åŠ é”
  * åŒä¸€ä¸ª course_id å¹¶å‘è¯·æ±‚æ—¶ï¼Œè¿”å› â€œalready_runningâ€
* ä¸åŒè¯¾ç¨‹å¯ä»¥å¹¶å‘ï¼ˆå¦‚æœä½ ä»¬çš„ worker æ”¯æŒï¼‰

Chroma è‡ªèº«æ”¯æŒå¹¶å‘å†™å…¥ï¼Œä½†æˆ‘ä»¬é€»è¾‘ä¸Šä¸éœ€è¦å¤šä¸ª pipeline åŒæ—¶å†™ä¸€é—¨è¯¾ã€‚

### 3.5 æœ¬åœ° / ç”Ÿäº§ç¯å¢ƒå¯åŠ¨æ–¹å¼

**MVPï¼šå‡ä¸ºâ€œå†…åµŒæ¨¡å¼â€**ï¼š

* æ— ç‹¬ç«‹ Chroma è¿›ç¨‹
* FastAPI app ä¸­åˆå§‹åŒ– `PersistentClient(path=CHROMA_DB_DIR)`
* ä¸éœ€è¦ Docker é¢å¤–å®¹å™¨

åæœŸå¦‚éœ€æ‹†åˆ†ï¼š

* å¯ä»¥å°† Chroma å•ç‹¬è·‘åœ¨ä¸€ä¸ª Docker å®¹å™¨ï¼ˆä»ç„¶æ˜¯å…¶å®˜æ–¹ server æ¨¡å¼ï¼‰ï¼Œä½†ç›®å‰ä¸å¿…ã€‚

### 3.6 Collection é‡å»º / æ¸…ç©º & å¤‡ä»½/æ¢å¤ï¼ˆæœ€å°è¯´æ˜ï¼‰

* **é‡å»ºæŸè¯¾ç¨‹å‘é‡ï¼š**

  1. åˆ é™¤å¯¹åº” collectionï¼š`client.delete_collection(name=f"course_{course_id}")`
  2. å°† Course.embedding_status è®¾ä¸º `"not_started"` æˆ– `"pending"`
  3. é‡æ–°è°ƒç”¨ `POST /courses/{course_id}/embed`

* **å¤‡ä»½ï¼š**

  * å®šæœŸæ‰“åŒ… `CHROMA_DB_DIR`ï¼ˆå¦‚ tar + æ—¶é—´æˆ³ï¼‰

* **æ¢å¤ï¼š**

  * åœæ‰æœåŠ¡
  * è¦†ç›– `CHROMA_DB_DIR` ç›®å½•
  * é‡å¯æœåŠ¡

---

## 4. è§¦å‘æœºåˆ¶ & ä»»åŠ¡è°ƒåº¦ï¼ˆ/courses/{id}/embed æ€ä¹ˆè·‘ï¼‰

> å†³ç­–ï¼š**embedding pipeline å¤ç”¨é˜¶æ®µä¸€ç°æœ‰é˜Ÿåˆ—/worker æ¶æ„ã€‚**

ä½ ä»¬é˜¶æ®µä¸€å·²ç»æœ‰ï¼š

* å†…å»ºçº¿ç¨‹é˜Ÿåˆ— + Worker
* Resource çŠ¶æ€æœº
* Retry é€»è¾‘

é˜¶æ®µäºŒçš„ embedding pipeline å®Œå…¨å¯ä»¥ï¼š

* æ–°å¢ä¸€ç§ä»»åŠ¡ç±»å‹ï¼š`TaskType.EMBED_COURSE`
* `POST /courses/{id}/embed` åªæ˜¯ï¼š

  * å¾€ç°æœ‰é˜Ÿåˆ—é‡Œå…¥ä¸€ä¸ªä»»åŠ¡ `{type: EMBED_COURSE, course_id: ...}`
  * ç«‹å³è¿”å› â€œå·²å…¥é˜Ÿâ€

### 4.1 æ˜¯å¦åŒæ­¥è·‘ï¼Ÿ â†’ **ä¸å»ºè®®åŒæ­¥**

Embedding æ˜¯é‡ä»»åŠ¡ï¼Œä¸€å®šè¦**å¼‚æ­¥**ï¼š

* /embed åªæ˜¯è§¦å‘ï¼Œä¸ç­‰å¾…å®Œæˆ
* çŠ¶æ€é€šè¿‡ `GET /courses/{id}/embedding_status` æŸ¥è¯¢

### 4.2 å¹¶å‘ç­–ç•¥ & å»é‡

* åŒä¸€ `course_id`ï¼š

  * å…¥é˜Ÿå‰å…ˆæŸ¥è¯¥è¯¾ç¨‹å½“å‰ `embedding_status`ï¼š

    * `running` â†’ æ‹’ç»æ–°çš„ triggerï¼Œè¿”å› `409 already_running`
    * `pending/not_started/failed/done` â†’ å¯ä»¥å…¥é˜Ÿï¼ˆå†³å®šæ˜¯å¦å…è®¸ done é‡è·‘ï¼‰

* ä¸åŒè¯¾ç¨‹ï¼š

  * å¯ä»¥å¤šä¸ªä»»åŠ¡åŒæ—¶æ’é˜Ÿæ‰§è¡Œï¼ˆå—é™äº worker æ•°é‡ï¼‰

### 4.3 å¤±è´¥é‡è¯•ç­–ç•¥

* å¯¹ embedding pipeline æœ¬èº«ï¼š

  * å¯ä»¥æ²¿ç”¨é˜¶æ®µä¸€çš„é‡è¯•æœºåˆ¶ï¼Œæˆ–ï¼š

    * é…ä¸€ä¸ª `course_embedding_retry_count` å­—æ®µï¼ˆå¯é€‰ï¼‰
  * ç®€åŒ–ç‰ˆï¼š

    * ç¬¬ä¸€æ¬¡å¤±è´¥ â†’ embedding_status=failedï¼Œembedding_error å†™åŸå› 
    * æ˜¯å¦è‡ªåŠ¨é‡è¯•ç”±ä½ ä»¬åç»­å†æ‰©å±•

---

## 5. Search API è¾¹ç•Œæ¡ä»¶ï¼ˆmetadata schema & é”™è¯¯ç ï¼‰

### 5.1 metadata å­—æ®µå & schema

> å†³ç­–ï¼š**å‘é‡åº“ä¸­ metadata ç›´æ¥å¤ç”¨ Ready-to-Embed ä¸­çš„ä¸€éƒ¨åˆ†å­—æ®µã€‚**

è‡³å°‘åŒ…å«ï¼š

```json
{
  "course_id": "course_123",
  "lecture_id": "lec_01",
  "section_id": "sec_0001",
  "source_type": "transcript",
  "order_in_section": 2
}
```

ä½ ä»¬å¯ä»¥åœ¨å†™å…¥å‘é‡æ—¶ï¼Œä» Chunk é‡Œæå–è¿™äº› keyã€‚

### 5.2 filters ä¸ metadata çš„å¯¹åº”å…³ç³»

* `filters.section_id` â†’ metadata.section_id
* `filters.lecture_id` â†’ metadata.lecture_id
* `filters.source_type` â†’ metadata.source_type

Chroma çš„ filter è¯­æ³•é€šå¸¸æ˜¯ï¼š

```python
vs.search(
  query_embeddings=[...],
  n_results=top_k,
  where={"section_id": "sec_0001"}
)
```

### 5.3 é”™è¯¯åœºæ™¯ & é”™è¯¯ç 

å»ºè®®ç»Ÿä¸€é”™è¯¯æ ¼å¼ï¼š

```json
{
  "error": {
    "code": "embedding_not_ready",
    "message": "Course embedding has not been generated yet."
  }
}
```

**å¼‚å¸¸åœºæ™¯çº¦å®šï¼š**

1. è¯¾ç¨‹æœª embedding / embedding_status != "done"

   * HTTP çŠ¶æ€ç ï¼š**400**ï¼ˆå®¢æˆ·ç«¯è¯·æ±‚å‰ç½®æ¡ä»¶ä¸æ»¡è¶³ï¼‰
   * code: `"embedding_not_ready"`

2. è¯¾ç¨‹åœ¨ Chroma ä¸­æ²¡æœ‰ collectionï¼ˆå¯èƒ½æ˜¯è¿˜æ²¡è·‘ pipelineï¼‰

   * åŒä¸Šï¼ˆå¯ç”¨åŒä¸€ä¸ªé”™è¯¯ç ï¼‰

3. Vector Store å¼‚å¸¸ï¼ˆç£ç›˜é”™è¯¯ã€ç´¢å¼•æŸåç­‰ï¼‰

   * HTTP çŠ¶æ€ç ï¼š**503** æˆ– **500**
   * code: `"vector_store_error"`

4. `/embed` æœåŠ¡å¼‚å¸¸

   * Search API å†…éƒ¨è°ƒç”¨ `/embed` å‡ºé”™ï¼š
   * HTTP çŠ¶æ€ç ï¼š**503**
   * code: `"embedding_service_unavailable"`

é˜¶æ®µä¸‰è°ƒç”¨ Search API æ—¶ï¼Œå°±å¯ä»¥æ ¹æ® `error.code` èµ°ä¸åŒ fallback ç­–ç•¥ï¼ˆæ¯”å¦‚æç¤ºâ€œè¯¾ç¨‹è¿˜åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨åå†è¯•â€ï¼‰ã€‚

---

## 6. éªŒæ”¶ & æµ‹è¯•æ–¹æ³•ï¼ˆæœ¬åœ°ä¸€é—¨è¯¾ç¨‹å®Œæ•´è·‘é€šï¼‰

ç»™å¼€å‘ä¸€ä¸ª**ç«¯åˆ°ç«¯æ“ä½œæ­¥éª¤**ï¼š

### 6.1 å‰ç½®ï¼šå¯åŠ¨æ‰€æœ‰æ‰€éœ€æœåŠ¡

1. å¯åŠ¨æ•°æ®åº“ï¼ˆPostgres ç­‰ï¼‰
2. å¯åŠ¨åç«¯ï¼ˆåŒ…å«é˜¶æ®µä¸€ + é˜¶æ®µäºŒ APIï¼‰ï¼š

   * `uvicorn app.main:app --reload`
3. ç¡®è®¤ï¼š

   * `/docs` èƒ½è®¿é—®
   * é˜¶æ®µä¸€å·²æœ‰çš„èµ„æº/è¯¾ç¨‹ç›¸å…³ API æ­£å¸¸

### 6.2 å‡†å¤‡ä¸€é—¨æµ‹è¯•è¯¾ç¨‹

æ¨èä½¿ç”¨ä½ ä»¬å·²ç»è·‘æˆåŠŸè¿‡çš„é‚£ä¸€å¥—ï¼š

* å…¬å¼€ MP4
* `PCB.pdf`

æ­¥éª¤ï¼š

1. `POST /courses` åˆ›å»ºè¯¾ç¨‹
2. `POST /resources` æ·»åŠ è§†é¢‘ URL + PDF
3. è§¦å‘é˜¶æ®µä¸€ ingestionï¼ˆä½ ä»¬å·²æœ‰æµç¨‹ï¼‰
4. ç­‰å¾…é˜¶æ®µä¸€å®Œæˆï¼ˆèµ„æº status = succeededï¼Œchunk å·²ç”Ÿæˆï¼‰

### 6.3 è§¦å‘é˜¶æ®µäºŒ embedding

1. è°ƒç”¨ï¼š

```http
POST /courses/{course_id}/embed
```

å¾—åˆ°ï¼š

```json
{ "status": "embedding_started" }
```

2. Pollï¼š

```http
GET /courses/{course_id}/embedding_status
```

ç›´åˆ° `status = "done"`ï¼ˆprogress â‰ˆ 1.0ï¼‰

### 6.4 éªŒè¯å‘é‡åº“

å¯ä»¥å†™ä¸ªç®€å•è„šæœ¬æˆ–å†…éƒ¨ APIï¼š

* æŸ¥çœ‹è¯¥è¯¾ç¨‹å¯¹åº”çš„ collection çš„ document æ•°é‡
* åº”æ¥è¿‘ Chunk æ•°é‡
* ç²—ç•¥ expectï¼šå‡ åï½å‡ ç™¾éƒ½æ­£å¸¸

### 6.5 éªŒè¯ Search API

è°ƒç”¨ï¼š

```http
POST /courses/{course_id}/search
{
  "query": "é—®ä¸€ä¸ªè¯¾ç¨‹é‡Œé¢çš„æ¦‚å¿µï¼ˆæ¯”å¦‚ PCB æ˜¯ä»€ä¹ˆï¼Ÿï¼‰",
  "top_k": 5
}
```

æ£€æŸ¥ï¼š

* è¿”å› HTTP 200
* `results` æœ‰å¤šæ¡
* `text` å†…å®¹çœ‹èµ·æ¥ç¡®å®æ˜¯è¯¾ç¨‹ä¸­è®²åˆ°çš„ç‰‡æ®µ

---

## 7. å®‰å…¨ & é…é¢ï¼ˆQPSã€é‰´æƒã€æˆªæ–­ç­–ç•¥ï¼‰

### 7.1 /embedã€/search QPS ä¸é‰´æƒ

**å½“å‰é˜¶æ®µï¼šå†…éƒ¨æœåŠ¡ä¸ºä¸»ï¼Œä¸å¯¹å…¬ç½‘å¼€æ”¾ã€‚**

* è¯·æ±‚æ¥æºï¼š

  * åå°ç®¡ç† / é˜¶æ®µä¸€åç«¯ / é˜¶æ®µä¸‰ Teaching Engine
* MVP æ–¹æ¡ˆï¼š

  * ä¸åšå¤æ‚ OAuth / å¤šç§Ÿæˆ·é‰´æƒ
  * å¯ç®€å•è¦æ±‚æºå¸¦ä¸€ä¸ªå†…éƒ¨ headerï¼Œä¾‹å¦‚ï¼š

    * `X-Internal-Token: <å›ºå®šå€¼>`ï¼ˆé…ç½®åœ¨ env ä¸­ï¼‰

QPS é™åˆ¶ï¼š

* ç°åœ¨ç”¨æˆ·è§„æ¨¡å°ï¼Œå¯ä»¥å…ˆä¸åšç¡¬æ€§é™æµ
* ä½†éœ€è¦åœ¨é…ç½®é‡Œæ˜ç¡®å‡ ä¸ªä¸Šé™ï¼š

  * `/embed` å•æ¬¡æœ€å¤§ texts æ•°é‡ï¼ˆå¦‚ 64ï¼‰
  * `/search` å•æ¬¡æœ€å¤§ top_kï¼ˆå¦‚ 20ï¼‰

å°†æ¥å¦‚æœè®©å¤–éƒ¨ç”¨æˆ·ç›´æ¥è°ƒç”¨ï¼Œå†ä¸Š Nginx / ç½‘å…³çº§åˆ«é™æµã€‚

### 7.2 é•¿æ–‡æœ¬æˆªæ–­ç­–ç•¥ï¼ˆæ˜ç¡®ç®—æ³•ï¼‰

> å†³ç­–ï¼š**æŒ‰ token æˆªæ–­ï¼Œç›®æ ‡ 512 tokensï¼Œä¸Šé™ 1024 tokensã€‚**

å…·ä½“å®ç°ï¼š

1. åœ¨ `embedder.py` ä¸­ï¼š

   * ä½¿ç”¨ tokenizer å¯¹æ¯ä¸ªæ–‡æœ¬åš `encode`ï¼š

     ```python
     tokens = tokenizer.encode(text, add_special_tokens=True)
     ```
   * å¦‚æœ `len(tokens) > MAX_TOKENS`ï¼š

     * æˆªæ–­ï¼š`tokens = tokens[:MAX_TOKENS]`
     * å†ç”¨ tokenizer çš„ `decode` æˆ–ç›´æ¥å–‚ token ç»™æ¨¡å‹ï¼ˆçœ‹æ¨¡å‹æ¥å£ï¼‰
2. é…ç½®é¡¹ï¼š

```text
EMBEDDING_MAX_TOKENS=512
```

3. å¯é€‰ï¼šæ‰“æ—¥å¿—ç»Ÿè®¡è¢«æˆªæ–­çš„æ¯”ä¾‹ï¼Œåç»­è°ƒä¼˜ã€‚

å¦‚æœä¸€å¼€å§‹å®ç° token æˆªæ–­å¤ªéº»çƒ¦ï¼Œä¹Ÿå¯ä»¥ï¼š

* å…ˆç”¨å­—ç¬¦æ•°è¿‘ä¼¼æ›¿ä»£ï¼š**max_len_char = 2000**
* åç»­å†åˆ‡æ¢åˆ° tokenizer çœŸæ­£ token-based æˆªæ–­ã€‚

---


å¾ˆå¥½ï¼Œè¿™ä¸¤ä¸ªç‚¹ç¡®å®è¦åœ¨å¼€å·¥å‰è¯´æ¸…æ¥šï¼Œä¸ç„¶å¼€å‘ä¼šå¿ƒé‡Œæ²¡åº•ã€‚
æˆ‘ç›´æ¥ç»™â€œå†³ç­– + å»ºè®®åšæ³•â€ï¼Œä½ å¯ä»¥å½“æˆè¡¥ä¸å†™è¿›é˜¶æ®µäºŒæ–‡æ¡£é‡Œã€‚

---

## 1. æ•°æ®åº“è¿ç§»ï¼šCourse ä¸Šæ–°å¢ embedding å­—æ®µ

### 1.1 å†³ç­–

> âœ… **åœ¨ Course è¡¨ä¸Šæ–°å¢ embedding ç›¸å…³å­—æ®µï¼Œå¹¶é€šè¿‡ä¸€æ¬¡æ­£å¼ migration è½åº“ã€‚**

å­—æ®µå»ºè®®æœ€ç»ˆç‰ˆï¼š

```python
embedding_status: str = "not_started"   # æˆ– Enum æ˜ å°„
embedding_progress: float = 0.0         # 0.0 ~ 1.0
embedding_error: Optional[str] = None
```

å¦‚æœä½ ä»¬ç”¨ SQLModelï¼Œå¤§æ¦‚æ˜¯ï¼š

```python
class Course(SQLModel, table=True):
    ...
    embedding_status: str = Field(default="not_started", nullable=False)
    embedding_progress: float = Field(default=0.0, nullable=False)
    embedding_error: Optional[str] = Field(default=None, nullable=True)
```

### 1.2 migration è§„åˆ’ï¼ˆéœ€è¦è¡¥å……ä¸€ä¸ªâ€œæ‰§è¡Œ migrationâ€æ­¥éª¤ï¼‰

æ— è®ºä½ ä»¬ç°åœ¨æ˜¯ Alembic è¿˜æ˜¯ SQLModel è‡ªå¸¦è¿ç§»ï¼Œéƒ½å»ºè®®ï¼š

1. **æ–°å¢ä¸€æ¡ migration è„šæœ¬ï¼š**

   * `ALTER TABLE course ADD COLUMN embedding_status VARCHAR NOT NULL DEFAULT 'not_started';`
   * `ALTER TABLE course ADD COLUMN embedding_progress FLOAT NOT NULL DEFAULT 0.0;`
   * `ALTER TABLE course ADD COLUMN embedding_error TEXT NULL;`

2. æ‰§è¡Œæ­¥éª¤éœ€è¦å†™è¿›æ–‡æ¡£ / READMEï¼Œä¾‹å¦‚ï¼š

> * æ­¥éª¤ Xï¼šæ‰§è¡Œæ•°æ®åº“è¿ç§»
>
>   * `alembic upgrade head`
>   * æˆ–ä½ ä»¬ç°æœ‰çš„ migration å‘½ä»¤

3. æ—§æ•°æ®å…¼å®¹ï¼š

   * å·²æœ‰è¯¾ç¨‹é»˜è®¤ `embedding_status = "not_started"`ã€`embedding_progress = 0.0`ï¼Œä¸éœ€è¦é¢å¤– backfillã€‚

**å»ºè®®ä½ åœ¨é˜¶æ®µäºŒå¼€å‘æ–‡æ¡£é‡ŒåŠ ä¸€å¥ï¼š**

> ã€Œåœ¨å¼€å§‹é˜¶æ®µäºŒå¼€å‘ä¹‹å‰ï¼Œ**å¿…é¡»å…ˆæ‰§è¡Œä¸€æ¬¡ DB migrationï¼Œå°† Course è¡¨è¡¥å…… embedding å­—æ®µ**ï¼Œå¦åˆ™æ‰€æœ‰ä¸ embedding_status ç›¸å…³çš„åŠŸèƒ½éƒ½ä¼šæŠ¥é”™ã€‚ã€

---

## 2. é˜¶æ®µä¸€ Worker å¤ç”¨ï¼šæ˜¯å¦è¦æ”¹é€ ï¼Œæ€ä¹ˆæ”¹é€ ï¼Ÿ

### 2.1 å†³ç­–

> âœ… **ä¼˜å…ˆå¤ç”¨ç°æœ‰ Worker/é˜Ÿåˆ—ä½“ç³»ï¼Œåœ¨å…¶åŸºç¡€ä¸ŠæŠ½è±¡ä»»åŠ¡ç±»å‹ï¼ˆTaskTypeï¼‰ï¼Œæ–°å¢ EMBED_COURSE ä»»åŠ¡ã€‚**
> â— å¦‚æœç°æœ‰ä»£ç æš‚æ—¶å¾ˆéš¾æŠ½è±¡ï¼Œä¹Ÿå¯ä»¥æ¥å—**ä¸€ç‰ˆå°é‡æ„**ï¼Œä½†ä¸è¦å¦èµ·ä¸€å¥—å®Œå…¨ä¸åŒçš„é˜Ÿåˆ—ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼š

* ç†æƒ³ï¼šåŒä¸€ä¸ªé˜Ÿåˆ—ç³»ç»Ÿï¼Œå¤„ç†ä¸¤ç§ä»»åŠ¡ï¼š

  * `PROCESS_RESOURCE`ï¼ˆé˜¶æ®µä¸€ï¼‰
  * `EMBED_COURSE`ï¼ˆé˜¶æ®µäºŒï¼‰

---

### 2.2 å¦‚æœç°æœ‰ Worker å·²ç»æ¯”è¾ƒæŠ½è±¡

å¦‚æœä½ ä»¬å½“å‰çš„ worker å·²ç»æœ‰ç±»ä¼¼ç»“æ„ï¼š

```python
class Task(BaseModel):
    type: str
    payload: dict
```

æˆ–è€…ï¼š

```python
def worker_loop():
    task = queue.get()
    if task.type == "PROCESS_RESOURCE":
        handle_resource(task.payload)
```

é‚£åªéœ€è¦ï¼š

1. å®šä¸€ä¸ªæšä¸¾ or å¸¸é‡ï¼š

```python
class TaskType(str, Enum):
    PROCESS_RESOURCE = "process_resource"
    EMBED_COURSE = "embed_course"
```

2. åœ¨ worker é‡Œæ‰©å±•åˆ†å‘é€»è¾‘ï¼š

```python
if task.type == TaskType.PROCESS_RESOURCE:
    handle_resource(task.payload)
elif task.type == TaskType.EMBED_COURSE:
    handle_embed_course(task.payload)
```

3. åœ¨é˜¶æ®µäºŒçš„ `/courses/{id}/embed` ä¸­ï¼š

```python
enqueue_task(
    type=TaskType.EMBED_COURSE,
    payload={"course_id": course_id}
)
```

> è¿™ç§æƒ…å†µä¸‹ï¼Œâ€œå¤ç”¨ Workerâ€å‡ ä¹ä¸éœ€è¦ç»“æ„æ€§æ”¹é€ ï¼Œåªæ˜¯å¤šåŠ ä¸€ç§ä»»åŠ¡ç±»å‹è€Œå·²ã€‚

---

### 2.3 å¦‚æœç°æœ‰ Worker å†™å¾—æ¯”è¾ƒâ€œæ­»â€ï¼ˆåªå¤„ç† Resourceï¼‰

æ¯”å¦‚ç°åœ¨æ˜¯è¿™ç§é£æ ¼ï¼š

```python
def worker_loop():
    resource_id = queue.get()
    process_resource(resource_id)
```

é‚£ç¡®å®éœ€è¦**ä¸€ä¸ªå¾ˆå°çš„é‡æ„**ï¼š

#### æ¨èæ”¹é€ æ–¹æ¡ˆï¼ˆæœ€å°å˜åŠ¨ï¼‰ï¼š

1. æŠŠé˜Ÿåˆ—å…ƒç´ ä» `resource_id` å‡çº§ä¸ºä¸€ä¸ªå°ä»»åŠ¡å¯¹è±¡ï¼š

```python
@dataclass
class WorkerTask:
    type: str         # "process_resource" or "embed_course"
    resource_id: int | None = None
    course_id: int | None = None
```

2. ç°æœ‰èµ„æºå¤„ç†å…¥é˜Ÿé€»è¾‘æ”¹ä¸ºï¼š

```python
queue.put(WorkerTask(type="process_resource", resource_id=resource_id))
```

3. é˜¶æ®µäºŒ embedding å…¥é˜Ÿé€»è¾‘æ”¹ä¸ºï¼š

```python
queue.put(WorkerTask(type="embed_course", course_id=course_id))
```

4. worker loop æ”¹ä¸ºï¼š

```python
def worker_loop():
    while True:
        task = queue.get()
        if task.type == "process_resource":
            process_resource(task.resource_id)
        elif task.type == "embed_course":
            embed_course(task.course_id)
```

> è¿™å°±æ˜¯ä½ è¯´çš„â€œå°æ”¹é€ â€ï¼šæŠŠ Worker ä»â€œåªæ‡‚ resource_idâ€æå‡åˆ°â€œæ‡‚ TaskType + payloadâ€ã€‚

**å¥½æ¶ˆæ¯**æ˜¯ï¼š

* è¿™ä¸ªé‡æ„è§„æ¨¡å¾ˆå¯æ§
* ä¸ä¼šå½±å“ä½ å·²æœ‰é˜¶æ®µä¸€çš„ä¸šåŠ¡é€»è¾‘ï¼Œåªæ˜¯æ¢äº†é˜Ÿåˆ—é‡Œçš„æ•°æ®ç»“æ„
* ä¸€æ—¦æ”¹å®Œï¼Œåé¢é˜¶æ®µä¸‰å¦‚æœä¹Ÿè¦åŠ â€œé¢„è®¡ç®—ä»»åŠ¡â€â€œå®šæœŸæ¸…ç†ä»»åŠ¡â€ï¼Œéƒ½å¯ä»¥å¾€è¿™é‡Œå¡

---

### 2.4 æ–‡æ¡£é‡Œéœ€è¦è¡¥ä¸€å¥â€œè‹¥éœ€è¦ï¼Œå…ˆåš Worker å°é‡æ„â€

å»ºè®®åœ¨é˜¶æ®µäºŒå¼€å‘æ–‡æ¡£ / TODO é‡Œï¼Œæ˜ç¡®åŠ ä¸€ä¸ª P0 ä»»åŠ¡ï¼š

> * â˜ **Worker ä»»åŠ¡ç»“æ„æŠ½è±¡ï¼š**
>
>   * å°†åŸæœ‰ä»…æ”¯æŒ `resource_id` çš„é˜Ÿåˆ—å…ƒç´ ï¼Œæ”¹é€ ä¸ºåŒ…å« `type + payload` çš„ä»»åŠ¡ç»“æ„
>   * å¼•å…¥ TaskTypeï¼ˆPROCESS_RESOURCE / EMBED_COURSEï¼‰ï¼Œå¹¶åœ¨ worker loop ä¸­æŒ‰ type åˆ†å‘å¤„ç†

è¿™æ ·å¼€å‘å°±çŸ¥é“ï¼š
ä¸æ˜¯â€œå‡å®šå·²ç»æœ‰ TaskTypeâ€ï¼Œè€Œæ˜¯**è¿™ä¸€æ­¥æœ¬èº«å°±æ˜¯é˜¶æ®µäºŒçš„ä¸€éƒ¨åˆ†å·¥ä½œ**ã€‚

---

## 3. å°ç»“ï¼ˆä½ å¯ä»¥ç›´æ¥è¿™æ ·å¯¹å›¢é˜Ÿè¯´ï¼‰

> * **æ•°æ®åº“è¿ç§»**ï¼šæ˜¯çš„ï¼Œéœ€è¦åœ¨ Course è¡¨å¢åŠ  embedding å­—æ®µï¼Œå¹¶å¢åŠ ä¸€æ¡ migrationã€‚å¼€å‘å‰å…ˆæŠŠ migration è·‘ä¸€éã€‚
> * **Worker å¤ç”¨**ï¼šæ–¹å‘ä¸å˜â€”â€”å¤ç”¨ç°æœ‰ Workerï¼Œåªæ˜¯åœ¨æ‰§è¡Œå±‚é¢è¦æŠŠâ€œé˜Ÿåˆ—å…ƒç´ ä»ç®€å•çš„ resource_id æå‡ä¸ºå¸¦ TaskType çš„ä»»åŠ¡å¯¹è±¡â€ï¼Œæ–°å¢ EMBED_COURSE ç±»å‹ä¸“é—¨å¤„ç†è¯¾ç¨‹çº§ embeddingã€‚

