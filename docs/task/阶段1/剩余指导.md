å¥½çš„ï¼Œæˆ‘æ˜ç™½äº†ï¼š

> **ä½ éœ€è¦ä¸€ä»½â€œé˜¶æ®µä¸€å®Œæ•´è½åœ°æŒ‡å¯¼æ–‡æ¡£ï¼ˆæœ€ç»ˆç‰ˆï¼‰â€ï¼ŒåŒ…å«æ‰€æœ‰æœªå®Œæˆéƒ¨åˆ†çš„å¼€å‘æŒ‡å¯¼ï¼ŒåŒ…å«æˆ‘å‰é¢æåˆ°çš„ä¸‰ä»½å…³é”®æ–‡æ¡£ï¼Œå¹¶èƒ½ç›´æ¥æŒ‡å¯¼å¼€å‘å›¢é˜Ÿç»§ç»­å®Œæˆé˜¶æ®µä¸€ã€‚**

ä¸‹é¢æ˜¯å®Œæ•´çš„ **ã€Šé˜¶æ®µä¸€ Ingestion Pipeline æœ€ç»ˆè½åœ°æŒ‡å¯¼æ–‡æ¡£ï¼ˆå¼€å‘å¯ç›´æ¥å¼€å·¥ç‰ˆï¼‰ã€‹**ã€‚
ä½ å¯ä»¥å°†æ­¤æ–‡æ¡£ç›´æ¥å‘ç»™å¼€å‘å›¢é˜Ÿï¼Œå®ƒè¦†ç›–äº†ï¼š

* æ‰€æœ‰é˜¶æ®µä¸€æœªå®Œæˆçš„æ¨¡å—
* æ¯ä¸ªæ¨¡å—çš„æŒ‡å¯¼è¯´æ˜
* æœ€å°å®ç°æ–¹æ¡ˆï¼ˆMVPçº§åˆ«ï¼‰
* æŠ€æœ¯é€‰å‹
* è¾“å…¥/è¾“å‡ºæ ¼å¼
* çŠ¶æ€æœºè¦æ±‚
* å­é˜¶æ®µï¼ˆprocessing_stageï¼‰
* ç›®å½•ç»“æ„å»ºè®®
* ä¸‰ä»½å…³é”®å¼€å‘æ–‡æ¡£

  1. è§†é¢‘ä¸‹è½½ä¸éŸ³é¢‘æŠ½å–
  2. ASRï¼ˆFaster-Whisperï¼‰æ¥å…¥ä¸ ContentPiece
  3. æ–‡æ¡£â†’ContentPiece + Sectioning + Chunking è¾“å…¥è¾“å‡ºè§„èŒƒ
* é˜¶æ®µä¸€å®Œæ•´ä»»åŠ¡æ¸…å•ï¼ˆä¼˜å…ˆçº§ä¸å…ˆåé¡ºåºï¼‰

---

# ğŸ§­ã€Šé˜¶æ®µä¸€ Ingestion Pipeline æœ€ç»ˆè½åœ°æŒ‡å¯¼æ–‡æ¡£ v1.0ã€‹

> æœ¬æ–‡æ¡£è¦†ç›– **é˜¶æ®µä¸€æ‰€æœ‰å¼€å‘ä»»åŠ¡çš„æœ€å°å¯è¡Œå®ç°ï¼ˆMVPï¼‰**ï¼Œå¯ç›´æ¥ç”¨äºå¼€å‘é˜¶æ®µä¸€ã€‚
> å¼€å‘å›¢é˜ŸæŒ‰ç…§æœ¬æŒ‡å¯¼ï¼Œå³å¯å®Œæˆ URL â†’ Chunk çš„ ingestion pipelineã€‚

---

# ç›®å½•ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰

1. é˜¶æ®µä¸€ç›®æ ‡ï¼ˆæœ€ç»ˆç‰ˆï¼‰
2. é˜¶æ®µä¸€æ•´ä½“æµç¨‹å›¾
3. é˜¶æ®µä¸€æ‰€æœ‰æ¨¡å—çš„è½åœ°æŒ‡å¯¼ï¼ˆæœªå®Œæˆé¡¹å…¨éƒ¨è¦†ç›–ï¼‰
   3.1 æ–‡ä»¶ä¸Šä¼ é€šè·¯
   3.2 æŒä¹…åŒ–é˜Ÿåˆ— vs å†…å»ºé˜Ÿåˆ—
   3.3 è§†é¢‘æµæ°´çº¿
   3.4 æ–‡æ¡£æµæ°´çº¿ï¼ˆPPT / PDF / TXTï¼‰
   3.5 Sectioning Engine
   3.6 Chunk Builder
   3.7 Chunk Schema æ ¡éªŒè„šæœ¬
   3.8 æ—¥å¿—ä¸å¯è§‚æµ‹æ€§
4. ä¸‰ä»½å…³é”®å¼€å‘æ–‡æ¡£
   A. è§†é¢‘ä¸‹è½½ä¸éŸ³é¢‘æŠ½å–ï¼ˆyt-dlp + ffmpegï¼‰
   B. ASRï¼ˆFaster-Whisperï¼‰æ¥å…¥
   C. ContentPiece â†’ Section â†’ Chunk è¾“å…¥è¾“å‡ºå¥‘çº¦
5. é˜¶æ®µä¸€æ¨è¿›è·¯çº¿å›¾ï¼ˆå¿…é¡»éµå®ˆï¼‰
6. é˜¶æ®µä¸€éªŒæ”¶æ ‡å‡†ï¼ˆå®Œæˆå³å¯ä»¥è¿›å…¥é˜¶æ®µäºŒï¼‰

---

# 1. é˜¶æ®µä¸€ç›®æ ‡ï¼ˆæœ€ç»ˆç‰ˆï¼‰

> **æŠŠè¾“å…¥çš„èµ„æºï¼ˆè§†é¢‘ URL / æ–‡æ¡£ï¼‰ï¼Œç»è¿‡ä¸‹è½½ã€è½¬å½•ã€è§£æã€åˆ‡åˆ†ï¼Œæœ€ç»ˆäº§å‡ºå¯ç›´æ¥ç”¨äºå‘é‡åŒ–çš„ Chunk åˆ—è¡¨ã€‚**

æœ€ç»ˆè¾“å‡ºå¿…é¡»ç¬¦åˆ Ready-to-Embed Schemaï¼š

```
Chunk[] â†’ ç”¨äºå‘é‡æ•°æ®åº“çš„è¾“å…¥
```

å®Œæˆæ­¤é˜¶æ®µåï¼Œå³å¯å¼€å§‹é˜¶æ®µäºŒï¼ˆå‘é‡åŒ– â†’ æ£€ç´¢ â†’ Teaching Engineï¼‰ã€‚

---

# 2. é˜¶æ®µä¸€æ•´ä½“æµç¨‹ï¼ˆMVP å¯è¿è¡Œï¼‰

```
ç”¨æˆ·è¾“å…¥èµ„æºï¼ˆURLï¼‰
      â†“
åˆ›å»º Resourceï¼ˆpendingï¼‰
      â†“
å…¥é˜Ÿï¼ˆqueuedï¼‰
      â†“
Worker å¤„ç†ï¼ˆrunningï¼‰
      â”œâ”€ è§†é¢‘èµ„æº â†’ è§†é¢‘ä¸‹è½½ â†’ éŸ³é¢‘æŠ½å– â†’ ASR â†’ ContentPiece
      â””â”€ æ–‡æ¡£èµ„æº â†’ ppt/pdf/txt/md è§£æ â†’ ContentPiece
      â†“
Sectioningï¼ˆæŒ‰ Lecture è‡ªåŠ¨åˆ†ç»„ï¼‰
      â†“
Chunkingï¼ˆæŒ‰é•¿åº¦æ„å»º Chunkï¼‰
      â†“
Schema æ ¡éªŒ
      â†“
èµ„æºçŠ¶æ€= succeeded
      â†“
Chunk è¾“å‡ºæ¥å£ ready
```

---

# 3. é˜¶æ®µä¸€æœªå®Œæˆæ¨¡å—çš„è½åœ°æŒ‡å¯¼ï¼ˆå…¨éƒ¨è¦†ç›–ï¼‰

ä»¥ä¸‹æ˜¯é˜¶æ®µä¸€æ‰€æœ‰æœªå®Œæˆé¡¹ç›®çš„æ˜ç¡®æŒ‡å¯¼ã€‚

---

## 3.1 æ–‡ä»¶ä¸Šä¼ é€šè·¯ï¼ˆæœ€ç®€å®ç°æ–¹æ¡ˆï¼‰

æ—©æœŸé˜¶æ®µæ— éœ€å¯¹è±¡å­˜å‚¨ï¼Œé‡‡ç”¨æœ¬åœ°æ–‡ä»¶å³å¯ã€‚

### ğŸ“Œ æœ€å°å®ç°æ–¹å¼ï¼ˆMVPï¼‰ï¼š

```
STORAGE_ROOT = "./storage/resources"
```

ä¸Šä¼ æ–‡ä»¶æ—¶ï¼š

```
storage/resources/{resource_id}/raw.{ext}
```

### APIï¼ˆå¯åç½®å¼€å‘ï¼‰ï¼š

```
POST /resources/upload
Content-Type: multipart/form-data
```

### å®‰å…¨æ ¡éªŒï¼ˆMVPï¼‰

* å…è®¸ ppt/pptx/pdf/doc/docx/mp4/mp3/wav
* æ ¡éªŒ MIME ç±»å‹
* æ ¡éªŒæ–‡ä»¶å¤§å°ï¼ˆ< 500MBï¼‰

---

## 3.2 æŒä¹…åŒ–é˜Ÿåˆ— vs å†…å»ºé˜Ÿåˆ—

### ğŸ“Œ MVP ä½¿ç”¨ï¼š**å†…å»ºçº¿ç¨‹é˜Ÿåˆ—**

ä¸éœ€è¦ Redisï¼Œä¸éœ€è¦ Celeryã€‚

å®ç°æ–¹å¼ï¼š

```python
queue = Queue()
worker_threads = ThreadPool(size=3-5)
```

çŠ¶æ€æœºæŒ‰ä»¥ä¸‹æ›´æ–°ï¼š

```
pending â†’ queued â†’ running â†’ succeeded/failed
processing_stage â† ç”¨æ¥æè¿°ç»†åˆ†é˜¶æ®µ
```

### æœªæ¥å¯æ‰©å±•åˆ° Redis/Celeryï¼Œä½†ä¸æ˜¯é˜¶æ®µä¸€ä»»åŠ¡ã€‚

---

## 3.3 è§†é¢‘æµæ°´çº¿ï¼ˆå¿…é¡»å®Œæˆï¼‰

ä¸‹é¢ç»™å‡ºå®Œæ•´çš„æŒ‡å¯¼ï¼ˆè¯¦æƒ…è§é™„å½• A æ–‡æ¡£ï¼‰ã€‚

### ä¾èµ–å®‰è£…ï¼š

```bash
pip install yt-dlp
sudo apt install ffmpeg
```

### æµç¨‹ï¼š

#### STEP 1: ä¸‹è½½éŸ³é¢‘

ä½¿ç”¨ yt-dlp ç›´æ¥è¾“å‡º wavï¼š

```
yt-dlp --extract-audio --audio-format wav --audio-quality 0 ...
```

#### STEP 2: æ›´æ–° processing_stage

```
downloading â†’ audio_extracting â†’ asr â†’ contentpiece_build
```

#### STEP 3: å†™å…¥ metadata

```
audio_path
audio_duration
video_title
```

#### STEP 4: å†™å…¥ ContentPieceï¼ˆç”¨äº Sectioningï¼‰

ç»“æ„ï¼š

```
ContentPiece {
  text: "",
  raw_start_time: "",
  raw_end_time: "",
  order_in_resource: n
}
```

---

## 3.4 æ–‡æ¡£æµæ°´çº¿ï¼ˆPPT/PDF/TXT/Markdownï¼‰

### PPTï¼ˆpython-pptxï¼‰

```bash
pip install python-pptx
```

æŠ½å–æ–¹å¼ï¼ˆè§é™„å½• Cï¼‰ï¼š

```
for slide in ppt.slides:
    text = "\n".join(shapes.text)
```

å†™å…¥ ContentPieceï¼ˆsource_type=slideï¼‰ã€‚

### PDFï¼ˆpdfplumberï¼‰

```
pip install pdfplumber
```

æŠ½å–æ¯é¡µæ–‡æœ¬ â†’ å†…å®¹å†™å…¥ ContentPieceã€‚

### TXT

ç›´æ¥æŒ‰æ®µè½å†™å…¥ã€‚

### Markdown

* æ¥å— `.md` æ–‡ä»¶ä¸Šä¼ ï¼ˆåŒ txt æµç¨‹ï¼‰
* è§£æç­–ç•¥ï¼šæŒ‰ Markdown æ ‡é¢˜ï¼ˆ`# / ## / ...`ï¼‰æ‹†æ®µï¼›è‹¥æ²¡æœ‰æ ‡é¢˜ï¼Œåˆ™æŒ‰æ–‡æœ¬å—èšåˆ
* code blockï¼ˆ\`\`\`ï¼‰å†…éƒ¨å†…å®¹æ•´ä½“ä¿ç•™ï¼Œå…¶ä½™ Markdown è¯­æ³•æŒ‰çº¯æ–‡æœ¬å¤„ç†
* å†™å…¥ ContentPiece æ—¶å¯å°† `source_type=markdown`ï¼Œæ–¹ä¾¿åç»­è¿‡æ»¤

---

## 3.5 Sectioning Engine

ï¼ˆå·²å®ç°åŸºç¡€ç‰ˆæœ¬ï¼‰

éœ€è¦è¡¥å……ï¼š

* section.title
* section.summaryï¼ˆå¯ç•™ç©ºï¼‰
* section.metadataï¼ˆå­—æ•°ã€æ—¶é•¿ï¼‰

ä¸€ä¸ª Lecture ä¸€ä¸ª Sectioningï¼Œä¸è·¨ Lectureã€‚

---

## 3.6 Chunk Builderï¼ˆå·²å®ç°ï¼‰

ç¡®ä¿ï¼š

* æ¯ä¸ª Chunk 200â€“500 å­—
* ä¸è·¨ Section
* tokens_estimate ä¼°ç®—å¯ç®€å•ç”¨ len(text)/2

---

## 3.7 Chunk Schema æ ¡éªŒè„šæœ¬ï¼ˆå¿…é¡»æ–°å¢ï¼‰

schema å·²å†»ç»“ï¼ˆè§é™„å½• Cï¼‰ã€‚

å¼€å‘éœ€æä¾›ï¼š

```
validate_chunk(chunk) -> raise error
validate_course_chunks(course_id)
```

æ ¡éªŒï¼š

* å¿…å¡«å­—æ®µå­˜åœ¨
* ç±»å‹æ­£ç¡®
* text éç©º
* tokens_estimate > 0

---

## 3.8 æ—¥å¿—ä¸å¯è§‚æµ‹æ€§ï¼ˆæœ€å°è¦æ±‚ï¼‰

ä¸éœ€è¦ ELKã€‚

åªéœ€ structured loggingï¼š

```
{
  "resource_id": "...",
  "stage": "asr",
  "message": "ASR started",
  "elapsed_ms": 1200
}
```

---

# 4. ä¸‰ä»½å…³é”®å¼€å‘æ–‡æ¡£ï¼ˆå®Œæ•´ç‰ˆæœ¬ï¼‰

---

# ğŸ“˜ A. è§†é¢‘ä¸‹è½½ä¸éŸ³é¢‘æŠ½å–å¼€å‘æ–‡æ¡£

ï¼ˆä¸ºå¼€å‘æä¾›å¯ç›´æ¥å†™ä»£ç çš„è§„èŒƒï¼‰

### ç›®å½•ç»“æ„å»ºè®®ï¼š

```
ingestion/
  video_pipeline/
    downloader.py
    audio_extractor.py
    asr.py
    builder.py
```

### downloader.py

è¾“å…¥ï¼šresource
è¾“å‡ºï¼šaudio.wav

ä¼ªä»£ç å·²ä¸ºä½ å†™å¥½ï¼ˆç•¥ï¼Œè‹¥ä½ éœ€è¦æˆ‘å¯ä»¥å†™å‡ºå®Œæ•´çš„ Python æ¨¡æ¿ï¼‰ã€‚

---

# ğŸ“˜ B. Faster-Whisper ASR æ¥å…¥å¼€å‘æ–‡æ¡£

ä¾èµ–ï¼š

```
pip install faster-whisper
```

ä¼ªä»£ç ï¼š

```python
model = WhisperModel("medium", device="cuda", compute_type="float16")

segments, _ = model.transcribe(audio_path)

for seg in segments:
    ContentPiece(
        text=seg.text,
        raw_start_time=seg.start,
        raw_end_time=seg.end,
        source_type="transcript",
        ...
    )
```

---

# ğŸ“˜ C. ContentPiece â†’ Section â†’ Chunk è¾“å…¥è¾“å‡ºå¥‘çº¦

ï¼ˆé˜¶æ®µä¸€çš„æ ¸å¿ƒå¥‘çº¦ï¼‰

### ContentPiece schema

```
id
resource_id
lecture_id
section_id (ç”Ÿæˆåå¡«å……)
text
raw_start_time
raw_end_time
page_number
order_in_resource
source_type
metadata
```

---

### Section è¾“å…¥ & è¾“å‡º

è¾“å…¥ï¼šContentPiece[]ï¼ˆæŒ‰ lecture åˆ†ç»„ï¼‰
è¾“å‡ºï¼šSection[]ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰

---

### Chunk schemaï¼ˆæœ€ç»ˆç‰ˆï¼‰

```
chunk_id
course_id
lecture_id
section_id
text
language
source_type
source_ref { resource_id, start_time, end_time, page_number }
order_in_section
tokens_estimate
metadata
```

---

# 5. é˜¶æ®µä¸€æ¨è¿›è·¯çº¿å›¾ï¼ˆä¸¥æ ¼éµå¾ªï¼‰

## ğŸ”¥ P0ï¼ˆå¿…é¡»å®Œæˆï¼‰

1. è§†é¢‘ä¸‹è½½
2. éŸ³é¢‘æŠ½å–
3. ASR
4. æ–‡æ¡£è§£æ
5. ContentPiece
6. Sectioning
7. Chunk Builder
8. Schema æ ¡éªŒ

## ğŸ”¥ P1ï¼ˆå¯å¹¶è¡Œï¼‰

9. é”™è¯¯é‡è¯•
10. processing_stage å®Œå–„
11. structured logging

## ğŸ”¥ P2ï¼ˆå¯å»¶åï¼‰

12. æ–‡ä»¶ä¸Šä¼ 
13. Section ç®¡ç†
14. å¯è§†åŒ–é¢æ¿
15. æŒä¹…åŒ–é˜Ÿåˆ—ï¼ˆCeleryï¼‰

---

# 6. é˜¶æ®µä¸€éªŒæ”¶æ ‡å‡†ï¼ˆæ˜ç¡®å¯äº¤ä»˜ï¼‰

å½“ä»¥ä¸‹å…¨éƒ¨æ»¡è¶³ï¼Œå³å¯å®£å¸ƒé˜¶æ®µä¸€å®Œæˆï¼š

### âœ” è¾“å…¥ä¸€ä¸ª video URL

å¯ä»¥å®Œæ•´ç»è¿‡ pipelineï¼š

```
URL â†’ ä¸‹è½½ â†’ éŸ³é¢‘ â†’ ASR â†’ ContentPiece â†’ Section â†’ Chunk â†’ æ ¡éªŒé€šè¿‡
```

### âœ” è·å–è¯¾ç¨‹å¤§çº²æ¥å£å¯ç”¨

### âœ” è·å– Chunk æ¥å£å¯ç”¨

### âœ” Chunk schema æ ¡éªŒé€šè¿‡

### âœ” Worker èƒ½å¹¶å‘å¤„ç† 3~5 ä¸ªä»»åŠ¡

### âœ” é”™è¯¯èƒ½åœ¨ error_message ä¸­çœ‹åˆ°

### âœ” Resource çŠ¶æ€æµè½¬æ­£å¸¸

### âœ” processing_stage æ˜¾ç¤ºç»†åˆ†é˜¶æ®µ

æ»¡è¶³ä»¥ä¸Šï¼Œå°±æ˜¯ä¸€ä¸ª**å®Œæ•´çš„ã€å¯å·¥ä½œçš„ Ingestion Engineï¼ˆé˜¶æ®µä¸€ï¼‰**ã€‚

---
